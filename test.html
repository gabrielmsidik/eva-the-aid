<button id="c" onclick="go()">Start</button>
<input type="text" id='a' />
<button value="submit" onclick=dummy() />
<button onclick="end()">Stop</button>

<body>

<div id='b'>

</div>
<br/>
<div id='d'>

</div>
</body>



<!-- <button onclick="stop()">Stop</button> -->

<script>
    check = false;
    tabs = "    "

    function go() {
        check = true
        recognition.start();
    }

    function end() {
        check = false
        recognition.stop();
        processRecords();
    }

    window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    const recognition = new SpeechRecognition();

    recognition.interimResults = false;
    recognition.lang = 'en-US';
    recognition.maxAlternatives = 10;

    function dummy() {

        let transcript = document.getElementById("a").value
        console.log(transcript)
        transcript = transcript.toLowerCase();

        if (transcript.toLowerCase().search("eva") >= 0) {
            let intents = processSpeech(transcript);
            processIntent(intents, transcript);
        }
    }

    function processIntent(intents, transcript) {

        let body = document.querySelector("#b");
        let p = document.createElement("p");
        let dt = new Date();

        p.textContent = dt.toUTCString() + " " + transcript;
        console.log(p);
        body.appendChild(p);
    }

    function processSpeech(speech) {

        console.log("processing speech... ")

        keywords = new Map(
            [['blood pressure', 'bp'],
            ['sugar level', 'sl']]);

        let l = []
        keywords.forEach((value, key, map) => {
            if (speech.search(key) > 0)  {
                console.log("speech registered:", speech)
                l.push(value);
            }
        })
        return l;

    }

    let keywords = {
        'airway': [
            'airway',
            'area',
            "weigh",
            'Airy',
            'erica',
            'erika'
        ],
        'clear': [
            'clear',

        ],
        'patient': [
            'patient',
            'yishun',
            'bishan',
            'patience',
            'patients',
            'patent',
            'oceanside'
        ],
        'breathing': [
            'breathing','grieving','leaving','reading','weaving'
        ],
        'radial': [
            'radial',
            'radio',
            'reno'
        ],
        'blood pressure': [
            'blood pressure',
            'bp',
        ],
        'blood': [
            'blood'
        ],
        'pressure': [
            'pressure'
        ],
        'arrived': [
            'arrived',
            'reached',
            'arrival'
        ],
        'rapid': [
            'rapid',
            'very fast',
            'rapidly',
            'rabbit'
        ],
        'normal': [
            'normal'
        ],
        'pulse': [
            'pulse',
            'piles'
        ],
        'slow': [
            'slow'
        ],
        'present': [
            'president',
            'presents',
            'presence'
        ]
    }

    function processSpeechResults(recognitionResult) {

        possible_transcripts = []

        for(let alternativeIndex = 0; alternativeIndex < recognitionResult.length; alternativeIndex++) {
            // console.log(recognitionResult[alternativeIndex].transcript)
            possible_transcripts[alternativeIndex] = recognitionResult[alternativeIndex].transcript
        }

        detected_words = []
        possible_transcripts.forEach( 
            function(transcript) {
                words = transcript.split(' ')
                detected_words.push(...words)
            }
        )
        console.log(detected_words)

        detected_keywords = new Set()
        transcripts_with_detected_keywords = new Set()

        detected_words.forEach(
            function(word) {
                word = word.toLowerCase()
                for (let idx in keywords) {
                    if (keywords[idx].includes(word)) {
                        console.log(word)
                        detected_keywords.add(idx)
                        for (let p in possible_transcripts) {
                            if (possible_transcripts[p].search(word) >= 0) {
                                transcripts_with_detected_keywords.add(possible_transcripts[p]);
                            }
                        }
                    }
                }
            }
        )

        console.log(detected_keywords)
        let div = document.createElement("div");
        console.log("HELLO")
        console.log(transcripts_with_detected_keywords)
        console.log(detected_keywords)
        console.log(detected_keywords.size)
        console.log('Before entering if-loop on line 197')
        if (detected_keywords.size > 0) {
            div.textContent = "Lines with keywords\n"
            transcripts_with_detected_keywords.forEach((t) => {
                div.appendChild(document.createElement('t'))
                para = document.createElement("div")
                para.textContent += tabs + t + "\n";
                div.appendChild(para);
            })
            document.querySelector("#b").appendChild(div);
        } else {
            div.textContent = "Probable Lines\n"
            possible_transcripts.slice(0,4).forEach((t) => {
                div.appendChild(document.createElement('t'))
                para = document.createElement("div")
                para.textContent += tabs + t + "\n";
                div.appendChild(para);
            })
            document.querySelector("#b").appendChild(div);
        }


        
    }
    recognition.onresult = (e) => {
        console.log('Obtained Results')

        results = e.results;

        for(let index = 0; index < results.length; index++) {
            speechRecognitionResultObject = results
            // console.log(results)

            recognitionResult = results[0]
            // console.log(recognitionResult)
            processSpeechResults(recognitionResult)
            
        }

        // let transcript = Array.from(e.results)
        //     .map(result => result[0])
        //     .map(result => result.transcript)
        //     .join('')
        // if (e.results[0].isFinal) {
        //     if (transcript.toLowerCase().search("eva")) {
        //         processSpeech(transcript.toLowerCase());
        //         transcript = transcript.toLowerCase();
        //         if (transcript.toLowerCase().search("eva") >= 0) {
        //             let intents = processSpeech(transcript);
        //             processIntent(intents, transcript);
        //         }
        //     }
        //     console.log(transcript);
        //     //put it here
        // }
    }
    // recognition.onspeechend = function () {
    //     recognition.stop()
    //     recognition.start()
    //     console.log("here")
    //     // recognition.start();//start to always listen
    // }

    recognition.addEventListener('end', () => {
        if (check) {
            recognition.start()
        }
    });

    

    function enterInput(el) {
        console.log(el.textContent);
    }

    function processRecords() {
        b = document.querySelector("#b").querySelectorAll("p");
        texts = [];
        console.log(b);
        if (b == null) {
            return
        }
        for(let i in b) {
            texts.push(b[i].textContent);
        }
        n = document.createElement("p")
        n.textContent = JSON.stringify(texts);
        document.querySelector("#d").appendChild(n);
    }
</script>